-- [[ PROJECT: VIOLENCE DISTRICT - INSTANT V8.6 (PERFORMANCE + FULLBRIGHT + NO RED BALL) ]] --
if _G.ViolenceDistrict_Loaded then
    pcall(function() game:GetService("StarterGui"):SetCore("SendNotification", { Title = "System", Text = "Script is already loaded!", Duration = 3 }) end)
    return
end
_G.ViolenceDistrict_Loaded = true

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local StarterGui = game:GetService("StarterGui")
local TeleportService = game:GetService("TeleportService")
local Lighting = game:GetService("Lighting")
local Camera = Workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local Mouse = LocalPlayer:GetMouse()

local SETTINGS = {
    Key_ESP = Enum.KeyCode.E,
    Key_Noclip = Enum.KeyCode.R,
    Key_AutoSkill = Enum.KeyCode.G, 
    Key_AutoParry = Enum.KeyCode.V, 
    Key_Aimbot = Enum.KeyCode.X,
    Key_Fullbright = Enum.KeyCode.K, 
    Key_Rejoin = Enum.KeyCode.L,
    
    ESP_Enabled = false,              
    Noclip_Enabled = false,
    AutoSkill_Enabled = true,
    AutoParry_Enabled = false,
    Aimbot_Enabled = false,        
    Fullbright_Enabled = false, 
    
    Parry_Key = "RightClick", 
    Parry_MaxRange = 12, 
    Parry_PanicRange = 6.5,   
    Parry_Cooldown = 0.05, 
    
    Aimbot_HoldKey = Enum.UserInputType.MouseButton2,
    Aimbot_FOV = 150,                
    Aimbot_Smoothness = 0.2,        
    Aimbot_Prediction = 0.13,        
    
    SurvivorColor = Color3.fromRGB(0, 255, 100),    
    KillerColor = Color3.fromRGB(255, 0, 0),        
    SuspectColor = Color3.fromRGB(255, 170, 0),        
    GenColor = Color3.fromRGB(0, 255, 255),
    PalletColor = Color3.fromRGB(74, 255, 181),
    WindowColor = Color3.fromRGB(100, 180, 255),
    
    GUI_NAME = "SkillCheckPromptGui",
    FRAME_NAME = "Check",
    NEEDLE_NAME = "Line",
    GOAL_NAME = "Goal",
}

local KILLER_ITEMS = {"knife", "bat", "axe", "machete", "saw", "gun", "hammer", "sword", "katana", "pipe", "weapon"}
local SURVIVOR_ITEMS = {"medkit", "firstaid", "bandage", "flashlight", "phone", "key", "card", "soda"}
local ATTACK_KEYWORDS = {"attack", "swing", "slash", "lunge", "m1", "punch", "strike", "heavy", "light"} 
local ATTACK_IDS = { "111920872708571", "78935059863801", "139369275981139", "78432063483146", "132817836308238", "133963973694098", "74968262036854" }

if _G.ProScript_Connections then
    for _, conn in pairs(_G.ProScript_Connections) do if conn then pcall(function() conn:Disconnect() end) end end
end
_G.ProScript_Connections = {} 

local originalCollision = {}
local cachedNoclipParts = {}

local origLighting = {
    Ambient = Lighting.Ambient,
    OutdoorAmbient = Lighting.OutdoorAmbient,
    Brightness = Lighting.Brightness,
    FogEnd = Lighting.FogEnd,
    GlobalShadows = Lighting.GlobalShadows,
    ClockTime = Lighting.ClockTime
}

local function CacheNoclipParts(char)
    cachedNoclipParts = {}
    for _, v in pairs(char:GetDescendants()) do 
        if v:IsA("BasePart") then table.insert(cachedNoclipParts, v) end 
    end
end

local function SaveCollisionData(char)
    originalCollision = {}
    for _, v in pairs(char:GetDescendants()) do if v:IsA("BasePart") then originalCollision[v] = v.CanCollide end end
end

local function RestoreCollisionData(char)
    for part, canCollide in pairs(originalCollision) do if part and part.Parent then part.CanCollide = canCollide end end
    originalCollision = {}
end

local function ForceResetCollision(char)
    for _, v in pairs(char:GetDescendants()) do
        if v:IsA("BasePart") then
            if v.Name == "HumanoidRootPart" then v.CanCollide = false
            elseif v.Name:match("Leg") or v.Name:match("Foot") then v.CanCollide = false 
            else v.CanCollide = true end
        end
    end
end

local function CleanVisuals()
    for _, v in pairs(Workspace:GetDescendants()) do 
        if v.Name:match("ESP") and (v:IsA("Highlight") or v:IsA("BillboardGui")) then 
            v:Destroy() 
        end 
    end
end

CleanVisuals()

local function GetPlayerRole(plr)
    if not plr or not plr.Character then return "Unknown" end
    local success, teamName = pcall(function() return plr.Team.Name:lower() end)
    if success and teamName then
        if teamName:match("kill") or teamName:match("murder") then return "Killer" end
        if teamName:match("surviv") or teamName:match("innocent") then return "Survivor" end
    end
    local function CheckItems(container)
        for _, item in pairs(container:GetChildren()) do
            if item:IsA("Tool") then
                local name = item.Name:lower()
                for _, k in ipairs(KILLER_ITEMS) do if name:match(k) then return "Killer" end end
                for _, s in ipairs(SURVIVOR_ITEMS) do if name:match(s) then return "Survivor" end end
            end
        end
        return nil
    end
    local role = CheckItems(plr.Character)
    if not role and plr:FindFirstChild("Backpack") then role = CheckItems(plr.Backpack) end
    return role or "Suspect"
end

local function CreatePlayerESP(target, text, color)
    if not target or not target.Parent then return end
    local char = target.Parent
    local hi = char:FindFirstChild("RoleESP_Highlight") or Instance.new("Highlight", char)
    hi.Name, hi.FillColor, hi.OutlineColor, hi.FillTransparency, hi.OutlineTransparency = "RoleESP_Highlight", color, color, 1, 0
    local bg = target:FindFirstChild("RoleESP_Tag") or Instance.new("BillboardGui", target)
    bg.Name, bg.Size, bg.AlwaysOnTop, bg.StudsOffset = "RoleESP_Tag", UDim2.new(0, 200, 0, 50), true, Vector3.new(0, 3.5, 0)
    local tl = bg:FindFirstChild("Label") or Instance.new("TextLabel", bg)
    tl.Name, tl.BackgroundTransparency, tl.Size, tl.Font, tl.TextSize, tl.Text, tl.TextColor3, tl.TextStrokeTransparency, tl.TextStrokeColor3 = "Label", 1, UDim2.new(1, 0, 1, 0), Enum.Font.GothamBold, 13, text, color, 0, Color3.new(0,0,0)
end

local function UpdatePlayerESP()
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then return end
    local myPos = LocalPlayer.Character.HumanoidRootPart.Position
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
            pcall(function()
                local char = p.Character
                local humanoid = char:FindFirstChild("Humanoid")
                local role = GetPlayerRole(p)
                local dist = (myPos - char.HumanoidRootPart.Position).Magnitude
                local hpText = ""
                if humanoid and role == "Survivor" then
                    local hp = math.floor(humanoid.Health)
                    local maxHp = math.floor(humanoid.MaxHealth)
                    hpText = hp < maxHp and string.format(" [HP:%d%%]", (hp/maxHp)*100) or " [FULL]"
                end
                local color = (role == "Killer" and SETTINGS.KillerColor) or (role == "Suspect" and SETTINGS.SuspectColor) or SETTINGS.SurvivorColor
                local prefix = (role == "Killer" and "[KILLER] ") or (role == "Suspect" and "[?] ") or "[+] "
                CreatePlayerESP(char.HumanoidRootPart, prefix .. p.Name .. hpText .. string.format("\n[%d m]", math.floor(dist)), color)
            end)
        end
    end
end

local function GetGenProgress(model)
    local pct = tonumber(model:GetAttribute("RepairProgress")) or 0
    if pct > 0 and pct <= 1.001 then pct = pct * 100 end
    return math.floor(math.clamp(pct, 0, 100))
end

local cachedWorldObjects = {}

local function AddWorldObject(v)
    if v:IsA("Model") and not v:IsA("Character") then
        local name = v.Name:lower()
        if name:match("generator") or name:match("cipher") or name:match("repair") or name == "palletwrong" or name == "pallet" or name == "window" then
            table.insert(cachedWorldObjects, v)
        end
    end
end

for _, v in pairs(Workspace:GetDescendants()) do
    AddWorldObject(v)
end

Workspace.DescendantAdded:Connect(AddWorldObject)

local function UpdateWorldESP()
    local activeObjects = {}
    
    for _, v in ipairs(cachedWorldObjects) do
        if v and v.Parent then
            table.insert(activeObjects, v) 
            local name = v.Name:lower()
            
            if name:match("generator") or name:match("cipher") or name:match("repair") then
                local percent = GetGenProgress(v)
                if percent >= 99 then
                    local hi = v:FindFirstChild("GenESP_Highlight")
                    if hi then hi:Destroy() end
                    local tag = v:FindFirstChild("GenESP_Tag", true)
                    if tag then tag:Destroy() end
                else 
                    local hi = v:FindFirstChild("GenESP_Highlight") or Instance.new("Highlight", v)
                    hi.Name, hi.FillColor, hi.OutlineColor, hi.FillTransparency = "GenESP_Highlight", SETTINGS.GenColor, SETTINGS.GenColor, 0.4
                    local centerPart = v.PrimaryPart or v:FindFirstChild("HitBox") or v:FindFirstChildWhichIsA("BasePart")
                    if centerPart then
                        local bg = centerPart:FindFirstChild("GenESP_Tag") or Instance.new("BillboardGui", centerPart)
                        bg.Name, bg.Size, bg.AlwaysOnTop, bg.StudsOffset = "GenESP_Tag", UDim2.new(0, 150, 0, 40), true, Vector3.new(0, 2, 0)
                        local tl = bg:FindFirstChild("Label") or Instance.new("TextLabel", bg)
                        tl.Name, tl.BackgroundTransparency, tl.Size, tl.Font, tl.TextSize, tl.Text, tl.TextColor3, tl.TextStrokeTransparency = "Label", 1, UDim2.new(1, 0, 1, 0), Enum.Font.GothamBlack, 16, string.format("%d%%", percent), Color3.fromHSV(math.clamp((percent/100)*0.33, 0, 0.33), 1, 1), 0
                    end
                end
                
            elseif name == "palletwrong" or name == "pallet" then
                local centerPart = v.PrimaryPart or v:FindFirstChildWhichIsA("BasePart")
                local hi = v:FindFirstChild("ObjESP_Highlight") or Instance.new("Highlight", v)
                hi.Name, hi.FillColor, hi.OutlineColor, hi.FillTransparency, hi.OutlineTransparency = "ObjESP_Highlight", SETTINGS.PalletColor, SETTINGS.PalletColor, 0.8, 0.3
                hi.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
                
                if centerPart then
                    local oldTag = centerPart:FindFirstChild("ObjESP_Tag")
                    if oldTag then oldTag:Destroy() end
                end
                
            elseif name == "window" then
                local centerPart = v.PrimaryPart or v:FindFirstChildWhichIsA("BasePart")
                local oldHi = v:FindFirstChild("ObjESP_Highlight")
                if oldHi then oldHi:Destroy() end
                
                if centerPart then
                    local bg = centerPart:FindFirstChild("ObjESP_Tag") or Instance.new("BillboardGui", centerPart)
                    bg.Name, bg.Size, bg.AlwaysOnTop, bg.StudsOffset = "ObjESP_Tag", UDim2.new(0, 100, 0, 30), true, Vector3.new(0, 1.5, 0)
                    local tl = bg:FindFirstChild("Label") or Instance.new("TextLabel", bg)
                    tl.Name, tl.BackgroundTransparency, tl.Size, tl.Font, tl.TextSize, tl.Text, tl.TextColor3, tl.TextStrokeTransparency, tl.TextStrokeColor3 = "Label", 1, UDim2.new(1, 0, 1, 0), Enum.Font.GothamBold, 11, "[WINDOW]", SETTINGS.WindowColor, 0, Color3.new(0,0,0)
                end
            end
        end
    end
    cachedWorldObjects = activeObjects
end

local function LineInGoal(Line, Goal)
    local lr, gr = Line.Rotation % 360, Goal.Rotation % 360
    local gs, ge = (gr + 104) % 360, (gr + 114) % 360
    return gs > ge and (lr >= gs or lr <= ge) or (lr >= gs and lr <= ge)
end

local function AutoSkillCheck()
    if not SETTINGS.AutoSkill_Enabled then return end
    pcall(function()
        local mainGui = PlayerGui:FindFirstChild(SETTINGS.GUI_NAME)
        local checkFrame = mainGui and mainGui:FindFirstChild(SETTINGS.FRAME_NAME, true)
        if checkFrame and checkFrame.Visible then
            local needle, goal = checkFrame:FindFirstChild(SETTINGS.NEEDLE_NAME), checkFrame:FindFirstChild(SETTINGS.GOAL_NAME)
            if needle and goal and LineInGoal(needle, goal) then
                VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Space, false, game)
                task.wait() 
                VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Space, false, game)
            end
        end
    end)
end

local lastParryTime = 0
local function SpamParry()
    for i = 1, 3 do
        if SETTINGS.Parry_Key == "RightClick" then VirtualInputManager:SendMouseButtonEvent(0, 0, 1, true, game, 1) VirtualInputManager:SendMouseButtonEvent(0, 0, 1, false, game, 1)
        else VirtualInputManager:SendKeyEvent(true, SETTINGS.Parry_Key, false, game) VirtualInputManager:SendKeyEvent(false, SETTINGS.Parry_Key, false, game) end
        task.wait(0.01)
    end
end

local function IsFacingMe(myPos, killerRoot)
    local directionToMe = (myPos - killerRoot.Position).Unit
    local killerLook = killerRoot.CFrame.LookVector
    return directionToMe:Dot(killerLook) > 0.35 
end

local function AutoParryCheck()
    if not SETTINGS.AutoParry_Enabled or not LocalPlayer.Character then return end
    local myRoot = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not myRoot then return end
    local now = tick()
    if now - lastParryTime < SETTINGS.Parry_Cooldown then return end
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character then
            if GetPlayerRole(p) == "Killer" then
                local kHum = p.Character:FindFirstChild("Humanoid")
                local kRoot = p.Character:FindFirstChild("HumanoidRootPart")
                if kRoot and kHum and kHum.Health > 0 then
                    local dist = (kRoot.Position - myRoot.Position).Magnitude
                    if dist <= SETTINGS.Parry_MaxRange then
                        local isPanic = dist <= SETTINGS.Parry_PanicRange
                        if isPanic or IsFacingMe(myRoot.Position, kRoot) then
                            local animator = kHum:FindFirstChild("Animator") or p.Character:FindFirstChild("Animator")
                            if animator then
                                for _, track in pairs(animator:GetPlayingAnimationTracks()) do
                                    local shouldParry = false
                                    if track.Priority == Enum.AnimationPriority.Action or track.Priority == Enum.AnimationPriority.Action2 or track.Priority == Enum.AnimationPriority.Action3 then shouldParry = true end
                                    if not shouldParry then
                                        local name = track.Name:lower()
                                        local id = track.Animation.AnimationId
                                        for _, kw in ipairs(ATTACK_KEYWORDS) do if name:find(kw) then shouldParry = true break end end
                                        if not shouldParry then for _, aid in ipairs(ATTACK_IDS) do if id:find(aid) then shouldParry = true break end end end
                                    end
                                    if shouldParry then
                                        if not isPanic then if track.Length > 0 and track.TimePosition < 0.05 then task.wait(0.05) end end
                                        
                                        task.spawn(SpamParry) 
                                        lastParryTime = tick()
                                        
                                        -- ลบโค้ดสร้าง Part ลูกบอลสีแดงออกไปแล้ว
                                        
                                        return 
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
    end
end

local function GetClosestKiller()
    local closestTarget = nil
    local maxDist = SETTINGS.Aimbot_FOV
    local mousePos = Vector2.new(Mouse.X, Mouse.Y)
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character then
            if GetPlayerRole(p) == "Killer" then
                local hum = p.Character:FindFirstChild("Humanoid")
                local root = p.Character:FindFirstChild("HumanoidRootPart")
                if hum and root and hum.Health > 0 then
                    local screenPos, onScreen = Camera:WorldToViewportPoint(root.Position)
                    if onScreen then
                        local dist = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude
                        if dist < maxDist then
                            closestTarget = root
                            maxDist = dist
                        end
                    end
                end
            end
        end
    end
    return closestTarget
end

local function AutoAim()
    if not SETTINGS.Aimbot_Enabled then return end
    if not UserInputService:IsMouseButtonPressed(SETTINGS.Aimbot_HoldKey) then return end
    local target = GetClosestKiller()
    if target then
        local predictedPos = target.Position + (target.Velocity * SETTINGS.Aimbot_Prediction)
        local currentCamCF = Camera.CFrame
        local goalCF = CFrame.new(currentCamCF.Position, predictedPos)
        Camera.CFrame = currentCamCF:Lerp(goalCF, SETTINGS.Aimbot_Smoothness)
    end
end

RunService.RenderStepped:Connect(AutoSkillCheck)
RunService.RenderStepped:Connect(AutoAim) 

RunService.Heartbeat:Connect(AutoParryCheck)

RunService.Stepped:Connect(function()
    if SETTINGS.Noclip_Enabled and LocalPlayer.Character then
        for i = 1, #cachedNoclipParts do 
            local p = cachedNoclipParts[i]
            if p and p.Parent then p.CanCollide = false end
        end
    end
end)

coroutine.wrap(function() 
    while true do 
        if SETTINGS.ESP_Enabled then 
            pcall(UpdatePlayerESP) 
        end 
        task.wait(0.2) 
    end 
end)()

coroutine.wrap(function() 
    while true do 
        if SETTINGS.ESP_Enabled then 
            pcall(UpdateWorldESP)
        end 
        task.wait(1.5) 
    end 
end)()

local function SendNotify(titleText, descText) pcall(function() StarterGui:SetCore("SendNotification", { Title = titleText, Text = descText, Duration = 2 }) end) end

UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.KeyCode == SETTINGS.Key_ESP then
        SETTINGS.ESP_Enabled = not SETTINGS.ESP_Enabled
        if not SETTINGS.ESP_Enabled then CleanVisuals() end
        local status = SETTINGS.ESP_Enabled and "ON" or "OFF"
        SendNotify("ESP", status)
    elseif input.KeyCode == SETTINGS.Key_Noclip then
        SETTINGS.Noclip_Enabled = not SETTINGS.Noclip_Enabled
        if SETTINGS.Noclip_Enabled then 
            SaveCollisionData(LocalPlayer.Character)
            CacheNoclipParts(LocalPlayer.Character) 
        else 
            if next(originalCollision) then RestoreCollisionData(LocalPlayer.Character) else ForceResetCollision(LocalPlayer.Character) end 
        end
        local status = SETTINGS.Noclip_Enabled and "ON" or "OFF"
        SendNotify("Noclip", status)
    elseif input.KeyCode == SETTINGS.Key_AutoSkill then
        SETTINGS.AutoSkill_Enabled = not SETTINGS.AutoSkill_Enabled
        local status = SETTINGS.AutoSkill_Enabled and "ON" or "OFF"
        SendNotify("Auto Skill", status)
    elseif input.KeyCode == SETTINGS.Key_AutoParry then
        SETTINGS.AutoParry_Enabled = not SETTINGS.AutoParry_Enabled
        local status = SETTINGS.AutoParry_Enabled and "ON" or "OFF"
        SendNotify("Auto Parry", status)
    elseif input.KeyCode == SETTINGS.Key_Aimbot then
        SETTINGS.Aimbot_Enabled = not SETTINGS.Aimbot_Enabled
        local status = SETTINGS.Aimbot_Enabled and "ON (Hold Right Click)" or "OFF"
        SendNotify("Aimbot", status)
    elseif input.KeyCode == SETTINGS.Key_Fullbright then
        SETTINGS.Fullbright_Enabled = not SETTINGS.Fullbright_Enabled
        if SETTINGS.Fullbright_Enabled then
            origLighting.Ambient = Lighting.Ambient
            origLighting.OutdoorAmbient = Lighting.OutdoorAmbient
            origLighting.Brightness = Lighting.Brightness
            origLighting.FogEnd = Lighting.FogEnd
            origLighting.GlobalShadows = Lighting.GlobalShadows
            origLighting.ClockTime = Lighting.ClockTime
            
            Lighting.Ambient = Color3.fromRGB(255, 255, 255)
            Lighting.OutdoorAmbient = Color3.fromRGB(255, 255, 255)
            Lighting.Brightness = 2
            Lighting.FogEnd = 100000
            Lighting.GlobalShadows = false
            Lighting.ClockTime = 12
            SendNotify("Fullbright", "ON")
        else
            Lighting.Ambient = origLighting.Ambient
            Lighting.OutdoorAmbient = origLighting.OutdoorAmbient
            Lighting.Brightness = origLighting.Brightness
            Lighting.FogEnd = origLighting.FogEnd
            Lighting.GlobalShadows = origLighting.GlobalShadows
            Lighting.ClockTime = origLighting.ClockTime
            SendNotify("Fullbright", "OFF")
        end
    elseif input.KeyCode == SETTINGS.Key_Rejoin then
        SendNotify("Rejoining", "Please wait... Teleporting back to server.")
        task.wait(0.5)
        pcall(function() TeleportService:TeleportToPlaceInstance(game.PlaceId, game.JobId, LocalPlayer) end)
    end
end)

LocalPlayer.CharacterAdded:Connect(function(char)
    char:WaitForChild("HumanoidRootPart")
    if SETTINGS.Noclip_Enabled then
        SaveCollisionData(char)
        CacheNoclipParts(char)
    end
end)

SendNotify("V8.6 + FPS BOOST + FULLBRIGHT", "Loaded! (No Red Ball for Parry)")
